name: Third party build test
run-name: run ${{ github.run_id }} ref ${{ github.ref_name }}

on:
  push:
    branches:
      - feature/github-workflow

# env:
#   DD_GIT_REPOSITORY: 'https://github.com/iterorganization/imas-data-dictionary.git'
#   DD_VERSION: 'main'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]
        build-type: [RelWithDebInfo]

    runs-on: ${{ matrix.os }}

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # unshallow for setuptools-scm.get_version to discover tags

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: 'pyproject.toml' # Read python version from a file pyproject.toml

      - uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install linux Dependencies
        if: startsWith(matrix.os, 'ubuntu-')
        run: >
          sudo apt update && sudo apt install -y
          build-essential
          cmake
          cython3
          git
          libboost-dev
          libboost-filesystem-dev
          libboost-program-options-dev
          libhdf5-serial-dev
          ninja-build
          pkg-config
          capnproto
          libcapnp-dev
          libspdlog-dev
          libssl-dev
          libxml2-dev

      - name: Configure CMake (linux, macos)
        if: matrix.os != 'windows-latest'
        run: >
          cd third-party

          cmake -GNinja -Bbuild 
          -Wno-deprecated
          -DBUILD_SHARED_LIBS=ON
          -DCMAKE_BUILD_TYPE=Release
          -DSSLAUTHENTICATION=ON
          -DCLIENT_ONLY=ON
          -DENABLE_CAPNP=ON

      - name: Build
        run: |
          cd third-party
          cmake --build build

      - name: Install test-install
        run: |
          cd third-party
          cmake --build build --target install
